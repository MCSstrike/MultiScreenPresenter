<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Control Page</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='control.css') }}">
</head>
<body>
    <h1>Control Page</h1>
    <form method="POST">
        <!-- URL Controls -->
        <div class="url-controls">
            <label>URL 1:</label>
            <select id="url1-dropdown" onchange="updateUrlInput(1)">
                <option value="matchMaker">Match Maker</option>
                <option value="timer">Timer</option>
                <option value="other">Other</option>
            </select>
            <input type="text" id="url1-input" value="http://localhost:5000/view">
        </div>
        <div class="url-controls">
            <label>URL 2:</label>
            <select id="url2-dropdown" onchange="updateUrlInput(2)">
                <option value="matchMaker">Match Maker</option>
                <option value="timer">Timer</option>
                <option value="other">Other</option>
            </select>
            <input type="text" id="url2-input" value="http://localhost:5000/view">
        </div>

        <!-- Slider -->
        <div class="slider-container">
            <label>Page Division:</label>
            <div class="slider-wrapper">
                <div id="sliderValue" class="slider-value">50%</div>
                <input
                    type="range"
                    id="proxySplit"
                    name="proxy_split"
                    value="{{ proxy_split }}"
                    min="0"
                    max="100"
                    step="5"
                    oninput="handleSliderInteraction(this)"
                    onchange="validateSlider(this)"
                >
            </div>
        </div>

        <!-- Timer -->
        <div class="timer-container">
            <h2>Timer Controls</h2>
            <div class="timer-controls">
                <button onclick="controlTimer('start')">Start</button>
                <button onclick="controlTimer('pause')">Pause</button>
                <button onclick="controlTimer('reset')">Reset</button>
                <input type="number" id="setTimer" placeholder="Set Time (seconds)">
                <button onclick="setTimer()">Set Time</button>
            </div>
        </div>
    </form>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // Initialize WebSocket connection
        const socket = io();

        // Store the last valid value
        let lastValidValue = {{ proxy_split }};

        function handleSliderInteraction(slider) {
            const value = parseInt(slider.value, 10);

            // Prevent slider from moving into invalid ranges
            if (value > 0 && value < 20) {
                slider.value = value < 10 ? 0 : 20; // Snap to 0 or 20
            } else if (value > 80 && value < 100) {
                slider.value = value < 90 ? 80 : 100; // Snap to 80 or 100
            }

            // Update the displayed value
            const sliderValue = document.getElementById("sliderValue");
            sliderValue.innerText = `${slider.value}%`;

            // Position the value display dynamically
            const percentage = (slider.value - slider.min) / (slider.max - slider.min);
            const offset = percentage * slider.offsetWidth - slider.offsetWidth / 2;
            sliderValue.style.left = `${slider.offsetWidth / 2 + offset}px`;

            // Change color dynamically in invalid ranges
            if ((value > 0 && value < 20) || (value > 80 && value < 100)) {
                slider.classList.add("gray");
            } else {
                slider.classList.remove("gray");
                lastValidValue = value; // Update last valid value for valid stops
            }

            // Send the updated value to the server
            fetch("/update_split", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ proxy_split: slider.value }),
            })
                .then((response) => response.json())
                .then(() => {
                    // Refresh the /view page in the iframe
                    const viewIframe = document.getElementById("viewIframe");
                    if (viewIframe) {
                        // Add a cache-busting query parameter to force reload
                        const cacheBuster = new Date().getTime();
                        viewIframe.src = `/view?embedded=true&cache=${cacheBuster}`;
                    }
                })
                .catch((error) => console.error("Error updating proxy split:", error));
        }


        function validateSlider(slider) {
            const value = parseInt(slider.value, 10);

            // Ensure the slider stops only at valid points
            if (value > 0 && value < 20) {
                slider.value = value < 10 ? 0 : 20; // Snap to 0 or 20
            } else if (value > 80 && value < 100) {
                slider.value = value < 90 ? 80 : 100; // Snap to 80 or 100
            } else {
                lastValidValue = value; // Update last valid value for valid stops
            }

            // Update the displayed value
            const sliderValue = document.getElementById('sliderValue');
            sliderValue.innerText = `${slider.value}%`;

            // Position the value display dynamically
            const percentage = (slider.value - slider.min) / (slider.max - slider.min);
            const offset = percentage * slider.offsetWidth - slider.offsetWidth / 2;
            sliderValue.style.left = `${slider.offsetWidth / 2 + offset}px`;

            slider.classList.remove('gray');
        }

        // Update URL input based on dropdown selection
        function updateUrlInput(urlNumber) {
            const dropdown = document.getElementById(`url${urlNumber}-dropdown`);
            const input = document.getElementById(`url${urlNumber}-input`);
            const selectedValue = dropdown.value;

            if (selectedValue === "matchMaker") {
                input.value = "http://localhost:5000/matchMaker";
                input.disabled = true; // Disable the input
            } else if (selectedValue === "timer") {
                input.value = "http://localhost:5000/timer"; // Clear the input for custom entry
                input.disabled = true; // Enable the input
            } else if (selectedValue === "other") {
                input.value = ""; // Clear the input for custom entry
                input.disabled = false; // Enable the input
            }
        }

        function updateProxyUrls() {
            const url1 = document.getElementById("url1-input").value;
            const url2 = document.getElementById("url2-input").value;

            // Send the updated URLs to the server
            fetch("/update_urls", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url1, url2 }),
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log("URLs updated:", data);
                })
                .catch((error) => console.error("Error updating URLs:", error));
        }

        // Control the timer (start, pause, reset)
        function controlTimer(action) {
            let timeLeft = parseInt(document.getElementById("setTimer").value, 10) || 600;
            let running = false;

            if (action === "start") {
                running = true;
            } else if (action === "pause") {
                running = false;
            } else if (action === "reset") {
                timeLeft = 600; // Default 10 minutes
                running = false;
            }

            // Send updated timer state to the server
            fetch("/update_timer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ time_left: timeLeft, running: running }),
            }).catch((error) => console.error("Error updating timer:", error));
        }

        // Set a custom time
        function setTimer() {
            const timeLeft = parseInt(document.getElementById("setTimer").value, 10) || 600;

            fetch("/update_timer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ time_left: timeLeft, running: false }),
            }).catch((error) => console.error("Error setting timer:", error));
        }

        // Initialize the slider behavior on page load
        document.addEventListener("DOMContentLoaded", () => {
            const slider = document.getElementById('proxySplit');
            handleSliderInteraction(slider);

            document.getElementById("url1-input").addEventListener("change", updateProxyUrls);
            document.getElementById("url2-input").addEventListener("change", updateProxyUrls);

            // Initialize the state of URL inputs
            updateUrlInput(1); // Initialize URL 1
            updateUrlInput(2); // Initialize URL 2
        });
    </script>
</body>
</html>