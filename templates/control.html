<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Control</title>
</head>
<body>
    <h1>Control Panel</h1>
    <p>Select which stream viewer1 should display:</p>
    <select id="streamSelectViewer1">
        <option value="">no stream selected</option>
    </select>

    <p>Select which stream viewer2 should display:</p>
    <select id="streamSelectViewer2">
        <option value="">no stream selected</option>
    </select>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const socket = io();

        const streamSelectViewer1 = document.getElementById('streamSelectViewer1');
        const streamSelectViewer2 = document.getElementById('streamSelectViewer2');

        let viewer1Current = null;
        let viewer2Current = null;

        // We'll track when we have received current streams for both viewers
        let gotViewer1Current = false;
        let gotViewer2Current = false;

        // Request current streams at page load
        socket.emit('request_current_stream', { viewer_id: 'viewer1' });
        socket.emit('request_current_stream', { viewer_id: 'viewer2' });

        // Once we know both current streams, we request the stream list
        function maybeRequestStreamList() {
            if (gotViewer1Current && gotViewer2Current) {
                // Now that we have both currents, request the latest list
                socket.emit('request_stream_list');
            }
        }

        // Listen for current streams
        socket.on('current_stream_viewer1', (streamName) => {
            viewer1Current = streamName;
            localStorage.setItem('currentStream_viewer1', streamName || '');
            gotViewer1Current = true;
            maybeRequestStreamList();
        });

        socket.on('current_stream_viewer2', (streamName) => {
            viewer2Current = streamName;
            localStorage.setItem('currentStream_viewer2', streamName || '');
            gotViewer2Current = true;
            maybeRequestStreamList();
        });

        // Listen for updates when a new stream is selected for a viewer
        socket.on('selected_stream_viewer1', (streamName) => {
            viewer1Current = streamName;
            localStorage.setItem('currentStream_viewer1', streamName || '');
            selectStreamInDropdown(streamSelectViewer1, streamName);
        });

        socket.on('selected_stream_viewer2', (streamName) => {
            viewer2Current = streamName;
            localStorage.setItem('currentStream_viewer2', streamName || '');
            selectStreamInDropdown(streamSelectViewer2, streamName);
        });

        // When we receive the stream list, update dropdowns and select current streams
        socket.on('stream_list', (streamNames) => {
            updateDropdown(streamSelectViewer1, streamNames);
            updateDropdown(streamSelectViewer2, streamNames);

            // Restore or fallback to no stream selected
            if (viewer1Current && streamNames.includes(viewer1Current)) {
                selectStreamInDropdown(streamSelectViewer1, viewer1Current);
            } else {
                selectStreamInDropdown(streamSelectViewer1, '');
            }

            if (viewer2Current && streamNames.includes(viewer2Current)) {
                selectStreamInDropdown(streamSelectViewer2, viewer2Current);
            } else {
                selectStreamInDropdown(streamSelectViewer2, '');
            }
        });

        // Update dropdown options
        function updateDropdown(dropdown, streamNames) {
            dropdown.innerHTML = '';
            // Always have the "no stream selected" option
            const noneOption = document.createElement('option');
            noneOption.value = '';
            noneOption.textContent = 'no stream selected';
            dropdown.appendChild(noneOption);

            // Add active streams
            streamNames.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                dropdown.appendChild(opt);
            });
        }

        // Select a given stream in the dropdown
        function selectStreamInDropdown(dropdown, streamName) {
            const option = Array.from(dropdown.options).find(o => o.value === streamName);
            if (option) {
                dropdown.value = streamName;
            } else {
                dropdown.value = '';
            }
        }

        // Re-fetch the stream list on dropdown click to get updated streams
        streamSelectViewer1.addEventListener('click', () => {
            socket.emit('request_stream_list');
        });

        streamSelectViewer2.addEventListener('click', () => {
            socket.emit('request_stream_list');
        });

        // When user selects a new stream from the dropdown
        streamSelectViewer1.addEventListener('change', () => {
            const selected = streamSelectViewer1.value;
            socket.emit('select_stream_for_viewer', {viewer_id: 'viewer1', streamName: selected});
        });

        streamSelectViewer2.addEventListener('change', () => {
            const selected = streamSelectViewer2.value;
            socket.emit('select_stream_for_viewer', {viewer_id: 'viewer2', streamName: selected});
        });
    </script>
</body>
</html>
